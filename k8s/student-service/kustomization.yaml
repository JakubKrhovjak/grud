# Student service overlay
# Patches the base templates with student-service specific values
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: grud

# Use base templates
resources:
  - ../base

# Name prefix for all resources
namePrefix: student-

# Common labels
commonLabels:
  app: student-service
  app.kubernetes.io/name: student-service

# Patches for service-specific values
patches:
  # Deployment patches
  - target:
      kind: Deployment
      name: service
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: ko://student-service/cmd/server
      - op: replace
        path: /spec/template/spec/containers/0/env/1/value
        value: student-db-rw.grud.svc.cluster.local
      - op: replace
        path: /spec/template/spec/containers/0/env/3/valueFrom/secretKeyRef/name
        value: student-db-app
      - op: replace
        path: /spec/template/spec/containers/0/env/4/valueFrom/secretKeyRef/name
        value: student-db-app
      - op: replace
        path: /spec/template/spec/containers/0/env/5/valueFrom/secretKeyRef/name
        value: student-db-app

  # Service patches
  - target:
      kind: Service
      name: service
    patch: |-
      - op: replace
        path: /spec/ports/0/nodePort
        value: 30080
