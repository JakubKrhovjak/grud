.PHONY: help setup install-operator deploy deploy-dev deploy-prod status logs cleanup

# Colors
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m # No Color

# Environment
export KO_DOCKER_REPO=kind.local
export KIND_CLUSTER_NAME=grud-cluster

help: ## Show this help
	@echo "$(BLUE)GRUD Kubernetes Deployment$(NC)"
	@echo ""
	@echo "$(GREEN)Available targets:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(BLUE)%-20s$(NC) %s\n", $$1, $$2}'

setup: ## Create Kind cluster (required first step)
	@echo "$(BLUE)üöÄ Creating Kind cluster...$(NC)"
	@../scripts/kind-setup.sh

install-operator: ## Install CloudNativePG operator (required before deploy)
	@echo "$(BLUE)üêò Installing CloudNativePG operator...$(NC)"
	@kubectl apply -k setup/
	@echo "$(BLUE)‚è≥ Waiting for operator to be ready...$(NC)"
	@kubectl wait --for=condition=Available deployment/cnpg-controller-manager -n cnpg-system --timeout=300s
	@echo "$(GREEN)‚úÖ Operator installed!$(NC)"

deploy: ## Deploy everything with Ko + Kustomize (production config)
	@echo "$(BLUE)üöÄ Building and deploying services...$(NC)"
	@ko resolve -f . | kubectl apply -f -
	@echo "$(GREEN)‚úÖ Deployment complete!$(NC)"

deploy-dev: ## Deploy with development overlay (1 replica each)
	@echo "$(BLUE)üöÄ Deploying to development...$(NC)"
	@ko resolve -f overlays/dev/ | kubectl apply -f -
	@echo "$(GREEN)‚úÖ Development deployment complete!$(NC)"

deploy-prod: ## Deploy with production overlay (3 replicas each)
	@echo "$(BLUE)üöÄ Deploying to production...$(NC)"
	@ko resolve -f overlays/prod/ | kubectl apply -f -
	@echo "$(GREEN)‚úÖ Production deployment complete!$(NC)"

build-only: ## Only build images without deploying
	@echo "$(BLUE)üî® Building images with Ko...$(NC)"
	@ko build ./student-service/cmd/server
	@ko build ./project-service/cmd/server

status: ## Show cluster status
	@echo "$(BLUE)üìã Cluster Status$(NC)"
	@echo ""
	@echo "$(YELLOW)Nodes:$(NC)"
	@kubectl get nodes -o wide
	@echo ""
	@echo "$(YELLOW)Deployments:$(NC)"
	@kubectl get deployments -n grud
	@echo ""
	@echo "$(YELLOW)Pods:$(NC)"
	@kubectl get pods -n grud -o wide
	@echo ""
	@echo "$(YELLOW)Services:$(NC)"
	@kubectl get services -n grud
	@echo ""
	@echo "$(YELLOW)Database Clusters:$(NC)"
	@kubectl get clusters -n grud

wait: ## Wait for all resources to be ready
	@echo "$(BLUE)‚è≥ Waiting for databases...$(NC)"
	@kubectl wait --for=condition=Ready cluster/student-db -n grud --timeout=300s
	@kubectl wait --for=condition=Ready cluster/project-db -n grud --timeout=300s
	@echo "$(BLUE)‚è≥ Waiting for services...$(NC)"
	@kubectl wait --for=condition=Available deployment/student-service -n grud --timeout=300s
	@kubectl wait --for=condition=Available deployment/project-service -n grud --timeout=300s
	@echo "$(GREEN)‚úÖ All resources ready!$(NC)"

logs: ## Follow logs for all services
	@echo "$(BLUE)üìú Following service logs...$(NC)"
	@kubectl logs -n grud -l 'app in (student-service,project-service)' -f --tail=50

logs-student: ## Follow student-service logs
	@kubectl logs -n grud -l app=student-service -f --tail=100

logs-project: ## Follow project-service logs
	@kubectl logs -n grud -l app=project-service -f --tail=100

logs-db: ## Follow database logs
	@kubectl logs -n grud -l postgresql -f --tail=50

test: ## Test services
	@echo "$(BLUE)üß™ Testing services...$(NC)"
	@echo ""
	@echo "$(YELLOW)Testing student-service:$(NC)"
	@curl -s http://localhost:8080/api/students | jq '.' || echo "Student service not responding"
	@echo ""
	@echo "$(YELLOW)Testing project-service:$(NC)"
	@curl -s http://localhost:8081/api/projects | jq '.' || echo "Project service not responding"

cleanup: ## Delete the entire cluster
	@../scripts/cleanup.sh

# Full workflow targets
all: setup install-operator deploy wait status ## Complete setup (cluster + operator + deploy)

dev: setup install-operator deploy-dev wait status ## Complete development setup

prod: setup install-operator deploy-prod wait status ## Complete production setup
