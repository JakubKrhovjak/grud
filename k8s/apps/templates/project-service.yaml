{{- if .Values.projectService.enabled }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: project-service
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "apps.componentLabels" (dict "componentName" "project-service" "root" .) | nindent 4 }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: project-service-config
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "apps.componentLabels" (dict "componentName" "project-service" "root" .) | nindent 4 }}
data:
  ENV: {{ .Values.projectService.config.env | quote }}
  GRPC_PORT: {{ .Values.projectService.config.grpcPort | quote }}
  NATS_URL: {{ .Values.projectService.config.natsUrl | quote }}
  NATS_SUBJECT: {{ .Values.projectService.config.natsSubject | quote }}
  OTEL_EXPORTER_OTLP_ENDPOINT: {{ .Values.projectService.config.otelEndpoint | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: project-service-file-config
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "apps.componentLabels" (dict "componentName" "project-service" "root" .) | nindent 4 }}
data:
  config.{{ .Values.projectService.config.env }}.yaml: |
    env: {{ .Values.projectService.config.env }}
    database:
      {{- if .Values.cloudSql.enabled }}
      host: {{ .Values.cloudSql.privateIp | quote }}
      {{- else }}
      host: {{ .Values.projectService.database.host }}
      {{- end }}
      port: {{ .Values.projectService.database.port | quote }}
      name: {{ .Values.projectService.database.name }}
      ssl_mode: {{ .Values.projectService.database.sslMode | default "disable" }}
    grpc:
      port: {{ .Values.projectService.config.grpcPort | quote }}
    nats:
      url: {{ .Values.projectService.config.natsUrl }}
      subject: {{ .Values.projectService.config.natsSubject }}
---
apiVersion: v1
kind: Service
metadata:
  name: project-service
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "apps.componentLabels" (dict "componentName" "project-service" "root" .) | nindent 4 }}
spec:
  type: ClusterIP
  ports:
    - port: 50052
      targetPort: 50052
      name: grpc
  selector:
    app: project-service
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: project-service
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "apps.componentLabels" (dict "componentName" "project-service" "root" .) | nindent 4 }}
spec:
  replicas: {{ .Values.projectService.replicaCount }}
  selector:
    matchLabels:
      app: project-service
  template:
    metadata:
      labels:
        app: project-service
        {{- include "apps.labels" . | nindent 8 }}
        component: project-service
    spec:
      {{- if .Values.projectService.tolerations }}
      tolerations:
        {{- toYaml .Values.projectService.tolerations | nindent 8 }}
      {{- end }}
      {{- if .Values.projectService.nodeSelector }}
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node-type
                    operator: In
                    values:
                      - {{ index .Values.projectService.nodeSelector "node-type" }}
      {{- end }}
      serviceAccountName: project-service
      containers:
        - name: project-service
          image: {{ .Values.projectService.image.repository }}:{{ .Values.projectService.image.tag }}
          imagePullPolicy: {{ .Values.projectService.image.pullPolicy }}
          ports:
            - containerPort: 50052
              name: grpc
          envFrom:
            - configMapRef:
                name: project-service-config
          env:
            - name: ENV
              value: {{ .Values.projectService.config.env | quote }}
            - name: GRPC_PORT
              value: {{ .Values.projectService.config.grpcPort | quote }}
            - name: DB_HOST
              {{- if .Values.cloudSql.enabled }}
              value: {{ .Values.cloudSql.privateIp | quote }}
              {{- else }}
              value: {{ .Values.projectService.database.host }}
              {{- end }}
            - name: DB_PORT
              value: {{ .Values.projectService.database.port | quote }}
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.projectService.database.secretName }}
                  key: database
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.projectService.database.secretName }}
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.projectService.database.secretName }}
                  key: password
          resources:
            {{- toYaml .Values.projectService.resources | nindent 12 }}
          livenessProbe:
            grpc:
              port: 50052
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          readinessProbe:
            grpc:
              port: 50052
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          volumeMounts:
            - name: config
              mountPath: /configs
              readOnly: true
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 65532
      volumes:
        - name: config
          configMap:
            name: project-service-file-config
{{- end }}