# kube-prometheus-stack Helm values for GRUD project
# Deploys Prometheus, Grafana, Alertmanager on infra node

# Global settings
defaultRules:
  create: true

# Prometheus configuration
prometheus:
  prometheusSpec:
    retention: 7d
    # Enable remote write receiver for Tempo metrics-generator
    enableRemoteWriteReceiver: true
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi

    # Schedule on infra node
    nodeSelector:
      node-type: infra
    tolerations:
      - key: "workload"
        operator: "Equal"
        value: "infra"
        effect: "NoSchedule"

    # Service monitors for OTel Collector and apps
    serviceMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelector: {}
    podMonitorSelectorNilUsesHelmValues: false
    podMonitorSelector: {}

  # Prometheus Service
  service:
    type: ClusterIP
    port: 9090

# Grafana configuration
grafana:
  enabled: true
  adminPassword: admin # Change this in production!

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Schedule on infra node
  nodeSelector:
    node-type: infra
  tolerations:
    - key: "workload"
      operator: "Equal"
      value: "infra"
      effect: "NoSchedule"

  # Service configuration - ClusterIP (accessed via Nginx Ingress with TLS)
  service:
    type: ClusterIP
    port: 80

  # Security context to fix permission issues
  securityContext:
    runAsUser: 472
    runAsGroup: 472
    fsGroup: 472

  # Disable init container that causes permission issues
  initChownData:
    enabled: false

  # Datasources are managed via ConfigMap with grafana_datasource label
  # See k8s/infra/grafana-datasources.yaml for Loki and Tempo
  # Prometheus and Alertmanager are added by kube-prometheus-stack automatically

  # Enable persistence for dashboards
  persistence:
    enabled: true
    size: 5Gi

# Alertmanager
alertmanager:
  alertmanagerSpec:
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi
    nodeSelector:
      node-type: infra
    tolerations:
      - key: "workload"
        operator: "Equal"
        value: "infra"
        effect: "NoSchedule"

  config:
    global:
      resolve_timeout: 5m
      # SMTP configuration - UPDATE THESE VALUES!
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'grud-alerts@gmail.com'
      smtp_auth_username: 'your-email@gmail.com'
      smtp_auth_password: 'your-app-password'
      smtp_require_tls: true

    route:
      group_by: ['alertname', 'service_name']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'email-notifications'
      routes:
        # Critical alerts - immediate
        - match:
            severity: critical
          receiver: 'email-notifications'
          group_wait: 10s
          repeat_interval: 1h
        # Warning alerts
        - match:
            severity: warning
          receiver: 'email-notifications'
          repeat_interval: 4h

    receivers:
      - name: 'email-notifications'
        email_configs:
          - to: 'jakub.krhovjak@protonmail.com'
            send_resolved: true
            headers:
              Subject: '[GRUD {{ .Status | toUpper }}] {{ .CommonLabels.alertname }}'

    inhibit_rules:
      - source_matchers:
          - severity = critical
        target_matchers:
          - severity = warning
        equal: ['alertname', 'service_name']

# Prometheus Node Exporter (runs on all nodes)
prometheus-node-exporter:
  tolerations:
    - operator: Exists

# Kube State Metrics
kube-state-metrics:
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi
  nodeSelector:
    node-type: infra
  tolerations:
    - key: "workload"
      operator: "Equal"
      value: "infra"
      effect: "NoSchedule"

# Prometheus Operator
prometheusOperator:
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi
  nodeSelector:
    node-type: infra
  tolerations:
    - key: "workload"
      operator: "Equal"
      value: "infra"
      effect: "NoSchedule"

  # Admission webhooks configuration
  admissionWebhooks:
    patch:
      nodeSelector:
        node-type: infra
      tolerations:
        - key: "workload"
          operator: "Equal"
          value: "infra"
          effect: "NoSchedule"
