# Grafana Alloy Helm values for GRUD project
# Receives OTLP metrics from Go services and exports to Prometheus
# Replaces OpenTelemetry Collector

alloy:
  # Stability level for components
  stabilityLevel: "generally-available"

  # Extra ports for OTLP receivers
  extraPorts:
    - name: otlp-grpc
      port: 4317
      targetPort: 4317
      protocol: TCP
    - name: otlp-http
      port: 4318
      targetPort: 4318
      protocol: TCP

  # Alloy configuration (River format)
  configMap:
    content: |
      // Logging configuration
      logging {
        level = "info"
        format = "logfmt"
      }

      // OTLP gRPC receiver - services send metrics/traces here on port 4317
      otelcol.receiver.otlp "default" {
        grpc {
          endpoint = "0.0.0.0:4317"
        }
        http {
          endpoint = "0.0.0.0:4318"
        }
        output {
          metrics = [otelcol.processor.batch.default.input]
          traces  = [otelcol.processor.batch.default.input]
        }
      }

      // Batch processor for better performance
      otelcol.processor.batch "default" {
        timeout = "10s"
        send_batch_size = 1024
        output {
          metrics = [otelcol.exporter.prometheus.default.input]
          traces  = [otelcol.exporter.otlp.tempo.input]
        }
      }

      // Convert OTLP metrics to Prometheus format and forward to remote_write
      // resource_to_telemetry_conversion adds service.name as service_name label
      otelcol.exporter.prometheus "default" {
        include_scope_info = true
        include_target_info = true
        resource_to_telemetry_conversion = true
        forward_to = [prometheus.relabel.add_labels.receiver]
      }

      // Add cluster label and ensure service_name exists
      prometheus.relabel "add_labels" {
        forward_to = [prometheus.remote_write.prometheus.receiver]

        rule {
          target_label = "cluster"
          replacement  = "grud-cluster"
        }
      }

      // Push metrics to Prometheus
      prometheus.remote_write "prometheus" {
        endpoint {
          url = "http://prometheus-kube-prometheus-prometheus.infra.svc.cluster.local:9090/api/v1/write"
        }
      }

      // Export traces to Tempo via OTLP
      otelcol.exporter.otlp "tempo" {
        client {
          endpoint = "tempo.infra.svc.cluster.local:4317"
          tls {
            insecure = true
          }
        }
      }

# Controller configuration
controller:
  type: deployment
  replicas: 1
  nodeSelector:
    node-type: infra
  tolerations:
    - key: "workload"
      operator: "Equal"
      value: "infra"
      effect: "NoSchedule"
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

# ServiceMonitor for Prometheus to scrape Alloy internal metrics
serviceMonitor:
  enabled: true
  additionalLabels:
    release: prometheus
  interval: 15s
