# =============================================================================
# HTTP to HTTPS Redirect for all domains
# =============================================================================
# Redirects all HTTP (port 80) traffic to HTTPS (port 443) with 301 status.
# This ensures all traffic is encrypted.
#
# How it works:
#   1. Client requests http://grudapp.com/api/students
#   2. Gateway matches HTTP listener (port 80)
#   3. This HTTPRoute matches and applies RequestRedirect filter
#   4. Client receives 301 redirect to https://grudapp.com/api/students
#   5. Client follows redirect to HTTPS
#
# Traffic flow:
#   http://example.com/path → 301 → https://example.com/path
#
# Note: This HTTPRoute has no backendRefs - it only redirects, never forwards.
#
# Docs: https://gateway-api.sigs.k8s.io/guides/http-redirect-rewrite/
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: http-to-https-redirect
  namespace: apps
spec:
  # Reference to parent Gateway - HTTP listener only
  parentRefs:
    - name: grud-gateway
      namespace: apps
      sectionName: http  # Only match HTTP listener (port 80)
  # Match all domains that need redirect
  hostnames:
    - "grudapp.com"
    - "grafana.grudapp.com"
    - "admin.grudapp.com"
  # Redirect rule - no backendRefs needed
  rules:
    - filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https      # Change scheme to HTTPS
            statusCode: 301    # Permanent redirect (SEO friendly)
