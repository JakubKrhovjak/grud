# =============================================================================
# HTTPRoute for ArgoCD (argo.grudapp.com)
# =============================================================================
# Routes HTTPS traffic to ArgoCD UI and API.
# Protected by Cloud IAP - requires Google authentication.
#
# Traffic flow:
#   Internet → Gateway → IAP Auth → HTTPRoute → Service → ArgoCD Pod
#
# Endpoints:
#   - https://argo.grudapp.com/* → argocd-gateway:80 (IAP protected)
#
# Cross-namespace routing:
#   This HTTPRoute is in 'infra' namespace but references Gateway in 'apps'.
#   Requires ReferenceGrant (k8s/gateway/reference-grant.yaml) to allow this.
#
# Related resources:
#   - Gateway: grud-gateway (k8s/gateway/gateway.yaml)
#   - Service: argocd-gateway (k8s/infra/argocd-backend.yaml)
#   - ReferenceGrant: allow-gateway-from-infra (reference-grant.yaml)
#   - HealthCheck: argocd-healthcheck (healthcheck-policies.yaml)
#   - BackendPolicy: argocd-iap-policy (gcp-backend-policy.yaml) - IAP config
#
# Docs: https://gateway-api.sigs.k8s.io/api-types/httproute/
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: argocd-route
  namespace: infra  # Different namespace than Gateway
spec:
  # Reference to parent Gateway (cross-namespace, requires ReferenceGrant)
  parentRefs:
    - name: grud-gateway
      namespace: apps
      sectionName: https  # Only match HTTPS listener (port 443)
  # Hostname matching
  hostnames:
    - "argo.grudapp.com"
  # Routing rules
  rules:
    # All paths → argocd-gateway service
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: argocd-gateway
          port: 80
