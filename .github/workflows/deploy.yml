name: Deploy to EKS

on:
  push:
    branches: [main]

permissions:
  id-token: write  # required for OIDC
  contents: read

env:
  AWS_REGION: eu-central-1
  EKS_CLUSTER: grud-cluster
  ECR_REGISTRY: 570617543021.dkr.ecr.eu-central-1.amazonaws.com

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 1. Authenticate to AWS via OIDC (no stored secrets)
      # -----------------------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # -----------------------------------------------------------------------
      # 2. Build and push images to ECR
      # -----------------------------------------------------------------------
      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: services/student-service/go.mod

      - name: Install ko
        uses: ko-build/setup-ko@v0.7

      - name: Build and push student-service
        env:
          KO_DOCKER_REPO: ${{ env.ECR_REGISTRY }}/grud/student-service
        run: |
          ko build --bare \
            -t ${{ github.sha }} \
            -t latest \
            --platform=linux/amd64 \
            ./services/student-service/cmd/student-service

      - name: Build and push project-service
        env:
          KO_DOCKER_REPO: ${{ env.ECR_REGISTRY }}/grud/project-service
        run: |
          ko build --bare \
            -t ${{ github.sha }} \
            -t latest \
            --platform=linux/amd64 \
            ./services/project-service/cmd/project-service

      - name: Build and push admin-panel
        run: |
          docker build \
            --platform=linux/amd64 \
            -t ${{ env.ECR_REGISTRY }}/grud/admin-panel:${{ github.sha }} \
            -t ${{ env.ECR_REGISTRY }}/grud/admin-panel:latest \
            services/admin
          docker push ${{ env.ECR_REGISTRY }}/grud/admin-panel:${{ github.sha }}
          docker push ${{ env.ECR_REGISTRY }}/grud/admin-panel:latest

      # -----------------------------------------------------------------------
      # 3. Deploy to EKS via Helm
      # -----------------------------------------------------------------------
      - name: Configure kubectl
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Helm deploy
        run: |
          helm upgrade --install apps k8s/apps \
            -n apps --create-namespace \
            -f k8s/apps/values-eks.yaml \
            --set studentService.image.tag=${{ github.sha }} \
            --set projectService.image.tag=${{ github.sha }} \
            --set adminPanel.image.tag=${{ github.sha }} \
            --atomic \
            --timeout 5m

      # -----------------------------------------------------------------------
      # 4. Verify deployment
      # -----------------------------------------------------------------------
      - name: Verify rollout
        run: |
          kubectl rollout status deployment/student-service -n apps --timeout=3m
          kubectl rollout status deployment/project-service -n apps --timeout=3m
          kubectl rollout status deployment/admin-panel -n apps --timeout=3m
